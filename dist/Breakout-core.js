/***
    Breakout - 0.2.3

    Copyright (c) 2011-2013 Jeff Hoefs <soundanalogous@gmail.com>
    Released under the MIT license. See LICENSE file for details.
    http://breakoutjs.com
    ***/
'use strict';var BO=BO||{},BREAKOUT=BREAKOUT||BO;BREAKOUT.VERSION="0.2.3";BO.enableDebugging=!1;var JSUTILS=JSUTILS||{};JSUTILS.namespace=function(a){var a=a.split("."),b=window,e;for(e=0;e<a.length;e+=1)"undefined"===typeof b[a[e]]&&(b[a[e]]={}),b=b[a[e]];return b};JSUTILS.inherit=function(a){function b(){}if(null===a)throw new TypeError;if(Object.create)return Object.create(a);var e=typeof a;if("object"!==e&&"function"!==e)throw new TypeError;b.prototype=a;return new b};
if(!Function.prototype.bind)Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),e=this,g=function(){},d=function(){return e.apply(this instanceof g?this:a||window,b.concat(Array.prototype.slice.call(arguments)))};g.prototype=this.prototype;d.prototype=new g;return d};JSUTILS.namespace("JSUTILS.Event");
JSUTILS.Event=function(){var a;a=function(a){this._type=a;this._target=null;this.name="Event"};a.prototype={constructor:a,get type(){return this._type},set type(a){this._type=a},get target(){return this._target},set target(a){this._target=a}};a.CONNECTED="connected";a.CHANGE="change";a.COMPLETE="complete";return a}();JSUTILS.namespace("JSUTILS.EventDispatcher");
JSUTILS.EventDispatcher=function(){var a;a=function(a){this._target=a||null;this._eventListeners={};this.name="EventDispatcher"};a.prototype={constructor:a,addEventListener:function(a,e){this._eventListeners[a]||(this._eventListeners[a]=[]);this._eventListeners[a].push(e)},removeEventListener:function(a,e){for(var g=0,d=this._eventListeners[a].length;g<d;g++)this._eventListeners[a][g]===e&&this._eventListeners[a].splice(g,1)},hasEventListener:function(a){return this._eventListeners[a]&&0<this._eventListeners[a].length?
!0:!1},dispatchEvent:function(a,e){a.target=this._target;var g=!1,d;for(d in e)e.hasOwnProperty(d)&&(a[d.toString()]=e[d]);if(this.hasEventListener(a.type)){d=0;for(var h=this._eventListeners[a.type].length;d<h;d++)try{this._eventListeners[a.type][d].call(this,a),g=!0}catch(i){console.log("error: Error calling event handler. "+i)}}return g}};return a}();JSUTILS.namespace("JSUTILS.TimerEvent");
JSUTILS.TimerEvent=function(){var a,b=JSUTILS.Event;a=function(a){this.name="TimerEvent";b.call(this,a)};a.TIMER="timerTick";a.TIMER_COMPLETE="timerComplete";a.prototype=JSUTILS.inherit(b.prototype);return a.prototype.constructor=a}();JSUTILS.namespace("JSUTILS.Timer");
JSUTILS.Timer=function(){var a,b=JSUTILS.TimerEvent,e=JSUTILS.EventDispatcher;a=function(a,d){e.call(this,this);this.name="Timer";this._count=0;this._delay=a;this._repeatCount=d||0;this._isRunning=!1;this._timer=null};a.prototype=JSUTILS.inherit(e.prototype);a.prototype.constructor=a;a.prototype.__defineGetter__("delay",function(){return this._delay});a.prototype.__defineSetter__("delay",function(a){this._delay=a;this._isRunning&&(this.stop(),this.start())});a.prototype.__defineGetter__("repeatCount",
function(){return this._repeatCount});a.prototype.__defineSetter__("repeatCount",function(a){this._repeatCount=a;this._isRunning&&(this.stop(),this.start())});a.prototype.__defineGetter__("running",function(){return this._isRunning});a.prototype.__defineGetter__("currentCount",function(){return this._count});a.prototype.start=function(){if(null===this._timer)this._timer=setInterval(this.onTick.bind(this),this._delay),this._isRunning=!0};a.prototype.reset=function(){this.stop();this._count=0};a.prototype.stop=
function(){if(null!==this._timer)clearInterval(this._timer),this._timer=null,this._isRunning=!1};a.prototype.onTick=function(){this._count+=1;0!==this._repeatCount&&this._count>this._repeatCount?(this.stop(),this.dispatchEvent(new b(b.TIMER_COMPLETE))):this.dispatchEvent(new b(b.TIMER))};return a}();JSUTILS.namespace("JSUTILS.SignalScope");
JSUTILS.SignalScope=function(){var a;a=function(a,e,g,d,h,i,c){this.name="SignalScope";this._canvas=document.getElementById(a);this._ctx=this._canvas.getContext("2d");this._width=e;this._height=g;this._rangeMin=d;this._rangeMax=h;this._ch1Color=i||"#FF0000";this._ch2Color=c||"#0000FF";this._markers=null;this._ch1Values=Array(e);this._ch2Values=Array(e);for(a=0;a<e;a++)this._ch1Values[a]=0,this._ch2Values[a]=0;this._range=100*(1/(h-d))};a.prototype.update=function(a,e){this._ctx.clearRect(0,0,this._width,
this._height);this._ch1Values.push(a);this._ch1Values.shift();this.drawChannel(this._ch1Values,this._ch1Color);void 0!==e&&(this._ch2Values.push(e),this._ch2Values.shift(),this.drawChannel(this._ch2Values,this._ch2Color));this.drawMarkers()};a.prototype.drawChannel=function(a,e){var g=0;this._ctx.strokeStyle=e;this._ctx.lineWidth=1;this._ctx.beginPath();this._ctx.moveTo(0,this._height);for(var d=0,h=a.length;d<h;d++)g=(this._rangeMax-a[d])*this._range,this._ctx.lineTo(d,g);this._ctx.stroke()};a.prototype.drawMarkers=
function(){var a=0;if(null!==this._markers)for(var e=0,g=this._markers.length;e<g;e++)a=(this._rangeMax-this._markers[e][0])*this._range,this._ctx.strokeStyle=this._markers[e][1],this._ctx.lineWidth=0.5,this._ctx.beginPath(),this._ctx.moveTo(0,a),this._ctx.lineTo(this._width,a),this._ctx.stroke()};a.prototype.addMarker=function(a,e){if(null===this._markers)this._markers=[];this._markers.push([a,e])};a.prototype.removeAllMarkers=function(){this._markers=null};return a}();JSUTILS.namespace("BO.IOBoardEvent");
BO.IOBoardEvent=function(){var a,b=JSUTILS.Event;a=function(a){this.name="IOBoardEvent";b.call(this,a)};a.ANALOG_DATA="analogData";a.DIGITAL_DATA="digitalData";a.FIRMWARE_VERSION="firmwareVersion";a.FIRMWARE_NAME="firmwareName";a.STRING_MESSAGE="stringMessage";a.SYSEX_MESSAGE="sysexMessage";a.PIN_STATE_RESPONSE="pinStateResponse";a.READY="ioBoardReady";a.CONNECTED="ioBoardConnected";a.DISCONNECTED="ioBoardDisonnected";a.prototype=JSUTILS.inherit(b.prototype);return a.prototype.constructor=a}();JSUTILS.namespace("BO.WSocketEvent");
BO.WSocketEvent=function(){var a,b=JSUTILS.Event;a=function(a){this.name="WSocketEvent";b.call(this,a)};a.CONNECTED="webSocketConnected";a.MESSAGE="webSocketMessage";a.CLOSE="webSocketClosed";a.prototype=JSUTILS.inherit(b.prototype);return a.prototype.constructor=a}();JSUTILS.namespace("BO.WSocketWrapper");
BO.WSocketWrapper=function(){var a,b=JSUTILS.EventDispatcher,e=BO.WSocketEvent;a=function(a,d,e){this.name="WSocketWrapper";b.call(this,this);this._host=a;this._port=d;this._protocol=e||"default-protocol";this._socket=null;this._readyState="";this.init(this)};a.prototype=JSUTILS.inherit(b.prototype);a.prototype.constructor=a;a.prototype.init=function(a){if("undefined"!==typeof io){a._socket=io.connect("http://"+a._host+":"+a._port);try{a._socket.on("connect",function(){a._socket.socket.options.reconnect=
!1;a.dispatchEvent(new e(e.CONNECTED));a._socket.on("message",function(i){a.dispatchEvent(new e(e.MESSAGE),{message:i})})})}catch(d){console.log("Error "+d)}}else try{if("MozWebSocket"in window)a._socket=new MozWebSocket("ws://"+a._host+":"+a._port+"/websocket",a._protocol);else if("WebSocket"in window)a._socket=new WebSocket("ws://"+a._host+":"+a._port+"/websocket");else throw console.log("Websockets not supported by this browser"),"Websockets not supported by this browser";a._socket.onopen=function(){a.dispatchEvent(new e(e.CONNECTED));
a._socket.onmessage=function(i){a.dispatchEvent(new e(e.MESSAGE),{message:i.data})};a._socket.onclose=function(){a._readyState=a._socket.readyState;a.dispatchEvent(new e(e.CLOSE))}}}catch(b){console.log("Error "+b)}};a.prototype.send=function(a){this.sendString(a)};a.prototype.sendString=function(a){this._socket.send(a.toString())};a.prototype.__defineGetter__("readyState",function(){return this._readyState});return a}();JSUTILS.namespace("BO.generators.GeneratorEvent");
BO.generators.GeneratorEvent=function(){var a,b=JSUTILS.Event;a=function(a){b.call(this,a);this.name="GeneratorEvent"};a.prototype=JSUTILS.inherit(b.prototype);a.prototype.constructor=a;a.UPDATE="update";return a}();JSUTILS.namespace("BO.generators.GeneratorBase");
BO.generators.GeneratorBase=function(){var a,b=JSUTILS.EventDispatcher;a=function(){b.call(this,this);this.name="GeneratorBase";this._value=void 0};a.prototype=JSUTILS.inherit(b.prototype);a.prototype.constructor=a;a.prototype.__defineGetter__("value",function(){return this._value});a.prototype.__defineSetter__("value",function(a){this._value=a});return a}();JSUTILS.namespace("BO.PinEvent");
BO.PinEvent=function(){var a,b=JSUTILS.Event;a=function(a){this.name="PinEvent";b.call(this,a)};a.CHANGE="pinChange";a.RISING_EDGE="risingEdge";a.FALLING_EDGE="fallingEdge";a.prototype=JSUTILS.inherit(b.prototype);return a.prototype.constructor=a}();JSUTILS.namespace("BO.Pin");
BO.Pin=function(){var a,b=JSUTILS.EventDispatcher,e=BO.PinEvent;a=function(a,d){this.name="Pin";this._type=d;this._capabilities={};this._number=a;this._analogNumber=void 0;this._maxPWMValue=255;this._value=0;this._lastValue=-1;this._average=this._preFilterValue=0;this._minimum=Math.pow(2,16);this._numSamples=this._sum=this._maximum=0;this._generator=this._filters=null;this._state=void 0;this._autoSetValueCallback=this.autoSetValue.bind(this);this._evtDispatcher=new b(this)};a.prototype={constructor:a,
setAnalogNumber:function(a){this._analogNumber=a},get analogNumber(){return this._analogNumber},get number(){return this._number},setMaxPWMValue:function(a){this._maxPWMValue=a},setState:function(g){this._type===a.PWM&&(g/=this.maxPWMValue);this._state=g},get maxPWMValue(){return this._maxPWMValue},get average(){return this._average},get minimum(){return this._minimum},get maximum(){return this._maximum},get state(){return this._state},get value(){return this._value},set value(a){this._lastValue=
this._value;this._preFilterValue=a;this._value=this.applyFilters(a);this.calculateMinMaxAndMean(this._value);this.detectChange(this._lastValue,this._value)},get lastValue(){return this._lastValue},get preFilterValue(){return this._preFilterValue},get filters(){return this._filters},set filters(a){this._filters=a},get generator(){return this._generator},getType:function(){return this._type},setType:function(b){if(0<=b&&b<a.TOTAL_PIN_MODES)this._type=b},getCapabilities:function(){return this._capabilities},
setCapabilities:function(a){this._capabilities=a},detectChange:function(a,d){a!==d&&(this.dispatchEvent(new e(e.CHANGE)),0>=a&&0!==d?this.dispatchEvent(new e(e.RISING_EDGE)):0!==a&&0>=d&&this.dispatchEvent(new e(e.FALLING_EDGE)))},clearWeight:function(){this._sum=this._average;this._numSamples=1},calculateMinMaxAndMean:function(a){var d=Number.MAX_VALUE;this._minimum=Math.min(a,this._minimum);this._maximum=Math.max(a,this._maximum);this._sum+=a;this._average=this._sum/++this._numSamples;this._numSamples>=
d&&this.clearWeight()},clear:function(){this._minimum=this._maximum=this._average=this._lastValue=this._preFilterValue;this.clearWeight()},addFilter:function(a){if(null!==a){if(null===this._filters)this._filters=[];this._filters.push(a)}},removeFilter:function(a){1>this._filters.length||(a=this._filters.indexOf(a),-1!==a&&this._filters.splice(a,1))},addGenerator:function(a){this.removeGenerator();this._generator=a;this._generator.addEventListener(BO.generators.GeneratorEvent.UPDATE,this._autoSetValueCallback)},
removeGenerator:function(){null!==this._generator&&this._generator.removeEventListener(BO.generators.GeneratorEvent.UPDATE,this._autoSetValueCallback);this._generator=null},removeAllFilters:function(){this._filters=null},autoSetValue:function(){this.value=this._generator.value},applyFilters:function(a){if(null===this._filters)return a;for(var d=this._filters.length,b=0;b<d;b++)a=this._filters[b].processSample(a);return a},addEventListener:function(a,d){this._evtDispatcher.addEventListener(a,d)},removeEventListener:function(a,
d){this._evtDispatcher.removeEventListener(a,d)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,d){return this._evtDispatcher.dispatchEvent(a,d)}};a.HIGH=1;a.LOW=0;a.ON=1;a.OFF=0;a.DIN=0;a.DOUT=1;a.AIN=2;a.AOUT=3;a.PWM=3;a.SERVO=4;a.SHIFT=5;a.I2C=6;a.TOTAL_PIN_MODES=7;return a}();JSUTILS.namespace("BO.PhysicalInputBase");
BO.PhysicalInputBase=function(){var a,b=JSUTILS.EventDispatcher;a=function(){this.name="PhysicalInputBase";this._evtDispatcher=new b(this)};a.prototype={constructor:a,addEventListener:function(a,b){this._evtDispatcher.addEventListener(a,b)},removeEventListener:function(a,b){this._evtDispatcher.removeEventListener(a,b)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,b){return this._evtDispatcher.dispatchEvent(a,b)}};return a}();JSUTILS.namespace("BO.I2CBase");
BO.I2CBase=function(){var a,b=BO.Pin,e=JSUTILS.EventDispatcher,g=BO.IOBoardEvent;a=function(d,h,i){if(void 0!==d){this.name="I2CBase";this.board=d;var c=i||0,i=c&255,c=c>>7&255;this._address=h;this._evtDispatcher=new e(this);h=d.getI2cPins();2===h.length?(d.getPin(h[0]).getType()!==b.I2C&&(d.getPin(h[0]).setType(b.I2C),d.getPin(h[1]).setType(b.I2C)),d.addEventListener(g.SYSEX_MESSAGE,this.onSysExMessage.bind(this)),d.sendSysex(a.I2C_CONFIG,[i,c])):console.log("Error, this board does not support i2c")}};
a.prototype={constructor:a,get address(){return this._address},onSysExMessage:function(d){var d=d.message,b=this.board.getValueFromTwo7bitBytes(d[1],d[2]),i=[];if(d[0]==a.I2C_REPLY&&b==this._address){for(var b=3,c=d.length;b<c;b+=2)i.push(this.board.getValueFromTwo7bitBytes(d[b],d[b+1]));this.handleI2C(i)}},sendI2CRequest:function(d){var b=[],i=d[0];b[0]=d[1];b[1]=i<<3;for(var i=2,c=d.length;i<c;i++)b.push(d[i]&127),b.push(d[i]>>7&127);this.board.sendSysex(a.I2C_REQUEST,b)},update:function(){},handleI2C:function(){},
addEventListener:function(a,b){this._evtDispatcher.addEventListener(a,b)},removeEventListener:function(a,b){this._evtDispatcher.removeEventListener(a,b)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,b){return this._evtDispatcher.dispatchEvent(a,b)}};a.I2C_REQUEST=118;a.I2C_REPLY=119;a.I2C_CONFIG=120;a.WRITE=0;a.READ=1;a.READ_CONTINUOUS=2;a.STOP_READING=3;return a}();JSUTILS.namespace("BO.IOBoard");
BO.IOBoard=function(){var a,b=BO.Pin,e=JSUTILS.EventDispatcher,g=BO.PinEvent,d=BO.IOBoardEvent,h={previous:0,shift:0,binaryData:[],startBinaryWrite:function(){this.shift=0;this.binaryData=[]},endBinaryWrite:function(){0<this.shift&&this.binaryData.push(this.previous)},writeBinary:function(a){a&=255;0===this.shift?(this.binaryData.push(a&127),this.shift++,this.previous=a>>7):(this.binaryData.push(a<<this.shift&127|this.previous),6===this.shift?(this.binaryData(a>>1),this.shift=0):(this.shift++,this.previous=
a>>8-this.shift))},readBinary:function(a,c){for(var f,b,d=[],e=0;e<a;e++)f=e<<3,b=f/7,f=f%7&255,d[e]=c[b]>>f|c[b+1]<<7-f&255;return d},num7BitOutbytes:function(a){return 7*a>>3}};a=function(a,c,f){this.name="IOBoard";this._socket=null;this._inputDataBuffer=[];this._digitalPort=[];this._numPorts=0;this._analogPinMapping=[];this._digitalPinMapping=[];this._i2cPins=[];this._ioPins=[];this._totalAnalogPins=this._totalPins=0;this._samplingInterval=19;this._isReady=!1;this._firmwareName="";this._firmwareVersion=
0;this._evtDispatcher=null;this._capabilityQueryResponseReceived=this._isConfigured=this._isMultiClientEnabled=!1;this._debugMode=BO.enableDebugging;this._numPinStateRequests=0;this._evtDispatcher=new e(this);this.initialVersionResultHandler=this.onInitialVersionResult.bind(this);this.sendOutHandler=this.sendOut.bind(this);this.socketConnectionHandler=this.onSocketConnection.bind(this);this.socketMessageHandler=this.onSocketMessage.bind(this);this.socketClosedHandler=this.onSocketClosed.bind(this);
this._socket=new BO.WSocketWrapper(a,c,f);this._socket.addEventListener(BO.WSocketEvent.CONNECTED,this.socketConnectionHandler);this._socket.addEventListener(BO.WSocketEvent.MESSAGE,this.socketMessageHandler);this._socket.addEventListener(BO.WSocketEvent.CLOSE,this.socketClosedHandler)};a.prototype={constructor:a,onSocketConnection:function(){this.debug("debug: Socket Status: (open)");this.dispatchEvent(new d(d.CONNECTED));this.begin()},onSocketMessage:function(a){var c=a.message,a=[];if(1<c.length)for(var a=
c.split(","),c=a.length,f=0;f<c;f++)this.parseInputMessage(a[f]);else this.parseInputMessage(c)},parseInputMessage:function(a){var c="";a.match(/config/)?(c=a.substr(a.indexOf(":")+2),this.processStatusMessage(c)):this.processInput(parseInt(a,10))},onSocketClosed:function(){this.debug("debug: Socket Status: "+this._socket.readyState+" (Closed)");this.dispatchEvent(new d(d.DISCONNECTED))},begin:function(){this.addEventListener(d.FIRMWARE_NAME,this.initialVersionResultHandler);this.reportFirmware()},
onInitialVersionResult:function(a){var c=10*a.version,f=a.name,b=this;this.removeEventListener(d.FIRMWARE_NAME,this.initialVersionResultHandler);this.debug("debug: Firmware name = "+f+", Firmware version = "+a.version);23<=c?this._isMultiClientEnabled?(this.queryCapabilities(),this.checkForQueryResponse()):(this.systemReset(),setTimeout(function(){b.queryCapabilities();b.checkForQueryResponse()},200)):console.log("error: You must upload StandardFirmata version 2.3 or greater from Arduino version 1.0 or higher")},
checkForQueryResponse:function(){var a=this;setTimeout(function(){!1===a._capabilityQueryResponseReceived&&a.startup()},200)},processStatusMessage:function(a){if("multiClient"===a)this.debug("debug: Multi-client mode enabled"),this._isMultiClientEnabled=!0},processInput:function(a){var c;this._inputDataBuffer.push(a);c=this._inputDataBuffer.length;if(128<=this._inputDataBuffer[0]&&240!=this._inputDataBuffer[0]){if(3===c)this.processMultiByteCommand(this._inputDataBuffer),this._inputDataBuffer=[]}else if(240===
this._inputDataBuffer[0]&&247===this._inputDataBuffer[c-1])this.processSysexCommand(this._inputDataBuffer),this._inputDataBuffer=[];else if(128<=a&&128>this._inputDataBuffer[0])console.log("warning: Malformed input data... resetting buffer"),this._inputDataBuffer=[],247!==a&&this._inputDataBuffer.push(a)},processMultiByteCommand:function(a){var c=a[0],f;240>c&&(c&=240,f=a[0]&15);switch(c){case 144:this.processDigitalMessage(f,a[1],a[2]);break;case 249:this._firmwareVersion=a[1]+a[2]/10;this.dispatchEvent(new d(d.FIRMWARE_VERSION),
{version:this._firmwareVersion});break;case 224:this.processAnalogMessage(f,a[1],a[2])}},processDigitalMessage:function(a,c,f){var e=8*a,a=e+8,c=c|f<<7,f={};if(a>=this._totalPins)a=this._totalPins;for(var j=0,g=e;g<a;g++){f=this.getDigitalPin(g);if(void 0===f)break;if(f.getType()==b.DIN&&(e=c>>j&1,e!=f.value))f.value=e,this.dispatchEvent(new d(d.DIGITAL_DATA),{pin:f});j++}},processAnalogMessage:function(a,c,f){a=this.getAnalogPin(a);if(void 0!==a)a.value=this.getValueFromTwo7bitBytes(c,f)/1023,a.value!=
a.lastValue&&this.dispatchEvent(new d(d.ANALOG_DATA),{pin:a})},processSysexCommand:function(a){a.shift();a.pop();switch(a[0]){case 121:this.processQueryFirmwareResult(a);break;case 113:this.processSysExString(a);break;case 108:this.processCapabilitiesResponse(a);break;case 110:this.processPinStateResponse(a);break;case 106:this.processAnalogMappingResponse(a);break;case 117:this.processShiftData(a);break;default:this.dispatchEvent(new d(d.SYSEX_MESSAGE),{message:a})}},processQueryFirmwareResult:function(a){for(var c,
f=3,b=a.length;f<b;f+=2)c=a[f],c+=a[f+1],this._firmwareName+=String.fromCharCode(c);this._firmwareVersion=a[1]+a[2]/10;this.dispatchEvent(new d(d.FIRMWARE_NAME),{name:this._firmwareName,version:this._firmwareVersion})},processSysExString:function(a){for(var c="",f,b=a.length,e=1;e<b;e+=2)f=a[e],f+=a[e+1],c+=String.fromCharCode(f);this.dispatchEvent(new d(d.STRING_MESSAGE),{message:c})},processShiftData:function(a){var c=a.length,a=a.slice(3),c=h.num7BitOutbytes(c-3),c=h.readBinary(c,a);console.log(c)},
processCapabilitiesResponse:function(a){if(!this._isConfigured){var c={},f=1,d=0,e=0,g=a.length,h;for(this._capabilityQueryResponseReceived=!0;f<=g;)if(127==a[f]){this._digitalPinMapping[d]=d;h=void 0;if(c[b.DOUT])h=b.DOUT;if(c[b.AIN])h=b.AIN,this._analogPinMapping[e++]=d;h=new b(d,h);h.setCapabilities(c);this.managePinListener(h);this._ioPins[d]=h;h.getCapabilities()[b.I2C]&&this._i2cPins.push(h.number);c={};d++;f++}else c[a[f]]=a[f+1],f+=2;this._numPorts=Math.ceil(d/8);this.debug("debug: Num ports = "+
this._numPorts);for(a=0;a<this._numPorts;a++)this._digitalPort[a]=0;this._totalPins=d;this._totalAnalogPins=e;this.debug("debug: Num pins = "+this._totalPins);this.queryAnalogMapping()}},processAnalogMappingResponse:function(a){if(!this._isConfigured){for(var c=a.length,f=1;f<c;f++)127!=a[f]&&(this._analogPinMapping[a[f]]=f-1,this.getPin(f-1).setAnalogNumber(a[f]));this._isMultiClientEnabled?this.startupInMultiClientMode():this.startup()}},startupInMultiClientMode:function(){for(var a=this.getPinCount(),
c=0;c<a;c++)this.queryPinState(this.getDigitalPin(c));setTimeout(this.startup.bind(this),500);this._isConfigured=!0},startup:function(){this.debug("debug: IOBoard ready");this._isReady=!0;this.enableDigitalPins();this.dispatchEvent(new d(d.READY))},systemReset:function(){this.debug("debug: System reset");this.send(255)},processPinStateResponse:function(a){if(!(0>=this._numPinStateRequests)){var c=a.length,f=a[2],b,e=this._ioPins[a[1]];4<c?b=this.getValueFromTwo7bitBytes(a[3],a[4]):3<c&&(b=a[3]);e.getType()!=
f&&(e.setType(f),this.managePinListener(e));e.setState(b);this._numPinStateRequests--;if(0>this._numPinStateRequests)this._numPinStateRequests=0;this.dispatchEvent(new d(d.PIN_STATE_RESPONSE),{pin:e})}},toDec:function(a){a=a.substring(0,1);return a.charCodeAt(0)},sendOut:function(a){var c=a.target.getType(),f=a.target.number,a=a.target.value;switch(c){case b.DOUT:this.sendDigitalData(f,a);break;case b.AOUT:this.sendAnalogData(f,a);break;case b.SERVO:this.sendServoData(f,a)}},managePinListener:function(a){if(a.getType()==
b.DOUT||a.getType()==b.AOUT||a.getType()==b.SERVO)a.hasEventListener(g.CHANGE)||a.addEventListener(g.CHANGE,this.sendOutHandler);else if(a.hasEventListener(g.CHANGE))try{a.removeEventListener(g.CHANGE,this.sendOutHandler)}catch(c){this.debug("debug: Caught pin removeEventListener exception")}},sendAnalogData:function(a,c){var f=this.getDigitalPin(a).maxPWMValue,c=c*f,c=0>c?0:c,c=c>f?f:c;15<a||c>Math.pow(2,14)?this.sendExtendedAnalogData(a,c):this.send([224|a&15,c&127,c>>7&127])},sendExtendedAnalogData:function(a,
c){var f=[];if(c>Math.pow(2,16))throw console.log("error: Extended Analog values > 16 bits are not currently supported by StandardFirmata"),"error: Extended Analog values > 16 bits are not currently supported by StandardFirmata";f[0]=240;f[1]=111;f[2]=a;f[3]=c&127;f[4]=c>>7&127;c>=Math.pow(2,14)&&(f[5]=c>>14&127);f.push(247);this.send(f)},sendDigitalData:function(a,c){var f=Math.floor(a/8);if(c==b.HIGH)this._digitalPort[f]|=c<<a%8;else if(c==b.LOW)this._digitalPort[f]&=~(1<<a%8);else{console.log("warning: Invalid value passed to sendDigital, value must be 0 or 1.");
return}this.sendDigitalPort(f,this._digitalPort[f])},sendServoData:function(a,c){var f=this.getDigitalPin(a);f.getType()==b.SERVO&&f.lastValue!=c&&this.sendAnalogData(a,c)},queryCapabilities:function(){this.send([240,107,247])},queryAnalogMapping:function(){this.send([240,105,247])},setAnalogPinReporting:function(a,c){this.send([192|a,c]);this.getAnalogPin(a).setType(b.AIN)},debug:function(a){this._debugMode&&console.log(a)},get samplingInterval(){return this._samplingInterval},set samplingInterval(a){10<=
a&&100>=a?(this._samplingInterval=a,this.send([240,122,a&127,a>>7&127,247])):console.log("warning: Sampling interval must be between 10 and 100")},get isReady(){return this._isReady},getValueFromTwo7bitBytes:function(a,c){return c<<7|a},getSocket:function(){return this._socket},reportVersion:function(){this.send(249)},reportFirmware:function(){this.send([240,121,247])},disableDigitalPins:function(){for(var a=0;a<this._numPorts;a++)this.sendDigitalPortReporting(a,b.OFF)},enableDigitalPins:function(){for(var a=
0;a<this._numPorts;a++)this.sendDigitalPortReporting(a,b.ON)},sendDigitalPortReporting:function(a,c){this.send([208|a,c])},enableAnalogPin:function(a){this.setAnalogPinReporting(a,b.ON)},disableAnalogPin:function(a){this.setAnalogPinReporting(a,b.OFF)},setDigitalPinMode:function(a,c){this.getDigitalPin(a).setType(c);this.managePinListener(this.getDigitalPin(a));this.send([244,a,c])},enablePullUp:function(a){this.sendDigitalData(a,b.HIGH)},getFirmwareName:function(){return this._firmwareName},getFirmwareVersion:function(){return this._firmwareVersion},
getPinCapabilities:function(){var a=[],c,f,b,d,e={"0":"input",1:"output",2:"analog",3:"pwm",4:"servo",5:"shift",6:"i2c"};c=this._ioPins.length;for(var g=0;g<c;g++){f={};b=this._ioPins[g].getCapabilities();d=!1;for(var h in b)b.hasOwnProperty(h)&&(d=!0,0<=h&&(f[e[h]]=this._ioPins[g].getCapabilities()[h]));a[g]=d?f:{"not available":"0"}}return a},queryPinState:function(a){this.send([240,109,a.number,247]);this._numPinStateRequests++},sendDigitalPort:function(a,c){this.send([144|a&15,c&127,c>>7])},sendString:function(a){for(var c=
[],b=0,d=a.length;b<d;b++)c.push(this.toDec(a[b])&127),c.push(this.toDec(a[b])>>7&127);this.sendSysex(113,c)},sendSysex:function(a,c){var b=[240];b[1]=a;for(var d=0,e=c.length;d<e;d++)b.push(c[d]);b.push(247);this.send(b)},sendServoAttach:function(a,c,f){var d=[],c=c||544,f=f||2400;d[0]=240;d[1]=112;d[2]=a;d[3]=c%128;d[4]=c>>7;d[5]=f%128;d[6]=f>>7;d[7]=247;this.send(d);a=this.getDigitalPin(a);a.setType(b.SERVO);this.managePinListener(a)},getNumBytesInValue:function(a){var c=0;do a>>=8,c++;while(a);
return c},encodeMultiByteValue:function(a){var c=0;h.startBinaryWrite();c=this.getNumBytesInValue(a);for(c-=1;0<=c;c--)h.writeBinary(a>>8*c);h.endBinaryWrite()},sendShiftConfig:function(a,c,d,e,g){var h=[240,117];h[2]=a<<3|1;h[3]=c.number;h[4]=d.number;h[5]=e||1;d.setType(b.DOUT);switch(a){case 2:case 4:case 5:case 6:c.setType(b.DOUT);break;case 3:case 7:c.setType(b.DIN)}g&&3<a?(h[6]=g.number,g.setType(b.DOUT)):g&&console.warn("must specify correct shiftType when using a latch pin");h.push(247);this.send(h)},
sendShiftOut:function(a,c){var b=[],d;b[0]=240;b[1]=117;b[2]=2;b[3]=a.number;this.encodeMultiByteValue(c);d=h.binaryData.length;for(var e=0;e<d;e++)b.push(h.binaryData[e]);b.push(247);this.send(b)},sendShiftIn:function(a,c){var b=[240,117,3];b[3]=a.number;b[4]=c||1;b[5]=247;this.send(b)},getPin:function(a){return this._ioPins[a]},getAnalogPin:function(a){return this._ioPins[this._analogPinMapping[a]]},getDigitalPin:function(a){return this._ioPins[this._digitalPinMapping[a]]},getPins:function(){return this._ioPins},
analogToDigital:function(a){return this.getAnalogPin(a).number},getPinCount:function(){return this._totalPins},getAnalogPinCount:function(){return this._totalAnalogPins},getI2cPins:function(){return this._i2cPins},reportCapabilities:function(){for(var a=this.getPinCapabilities(),c=a.length,b,d=0;d<c;d++){console.log("Pin "+d+":");for(var e in a[d])a[d].hasOwnProperty(e)&&(b=a[d][e],console.log("\t"+e+" ("+b+(1<b?" bits)":" bit)")))}},send:function(a){this._socket.sendString(a)},close:function(){this._socket.close()},
addEventListener:function(a,b){this._evtDispatcher.addEventListener(a,b)},removeEventListener:function(a,b){this._evtDispatcher.removeEventListener(a,b)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,b){return this._evtDispatcher.dispatchEvent(a,b)}};return a}();

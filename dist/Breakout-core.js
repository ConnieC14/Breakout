'use strict';var JSUTILS=JSUTILS||{};JSUTILS.namespace=function(a){var a=a.split("."),f=window,d;for(d=0;d<a.length;d+=1)"undefined"===typeof f[a[d]]&&(f[a[d]]={}),f=f[a[d]];return f};JSUTILS.inherit=function(a){function f(){}if(null==a)throw TypeError();if(Object.create)return Object.create(a);var d=typeof a;if("object"!==d&&"function"!==d)throw TypeError();f.prototype=a;return new f};
if(!Function.prototype.bind)Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var f=Array.prototype.slice.call(arguments,1),d=this,j=function(){},e=function(){return d.apply(this instanceof j?this:a||window,f.concat(Array.prototype.slice.call(arguments)))};j.prototype=this.prototype;e.prototype=new j;return e};JSUTILS.namespace("JSUTILS.Event");JSUTILS.Event=function(){var a;a=function(a){this.type=a;this.target=null;this.name="Event"};a.CONNECTED="connected";a.CHANGE="change";a.COMPLETE="complete";return a}();JSUTILS.namespace("JSUTILS.EventDispatcher");
JSUTILS.EventDispatcher=function(){var a;a=function(a){this._target=a||null;this._eventListeners={};this.name="EventDispatcher"};a.prototype={addEventListener:function(a,d){this._eventListeners[a]||(this._eventListeners[a]=[]);this._eventListeners[a].push(d)},removeEventListener:function(a,d){for(var j=0,e=this._eventListeners[a].length;j<e;j++)this._eventListeners[a][j]===d&&this._eventListeners[a].splice(j,1)},hasEventListener:function(a){return this._eventListeners[a]&&0<this._eventListeners[a].length?
!0:!1},dispatchEvent:function(a,d){a.target=this._target;var j=!1,e;for(e in d)a[e.toString()]=d[e];if(this.hasEventListener(a.type)){e=0;for(var c=this._eventListeners[a.type].length;e<c;e++)try{this._eventListeners[a.type][e].call(this,a),j=!0}catch(t){}}return j}};return a}();JSUTILS.namespace("JSUTILS.TimerEvent");JSUTILS.TimerEvent=function(){var a,f=JSUTILS.Event;a=function(a){this.name="TimerEvent";f.call(this,a)};a.TIMER="timerTick";a.TIMER_COMPLETE="timerComplete";a.prototype=JSUTILS.inherit(f.prototype);return a.prototype.constructor=a}();JSUTILS.namespace("JSUTILS.Timer");
JSUTILS.Timer=function(){var a,f=JSUTILS.TimerEvent,d=JSUTILS.EventDispatcher;a=function(a,e){d.call(this,this);this.name="Timer";this._count=0;this._delay=a;this._repeatCount=e||0;this._isRunning=!1;this._timer=null};a.prototype=JSUTILS.inherit(d.prototype);a.prototype.constructor=a;a.prototype.__defineGetter__("delay",function(){return this._delay});a.prototype.__defineSetter__("delay",function(a){this._delay=a;this._isRunning&&(this.stop(),this.start())});a.prototype.__defineGetter__("repeatCount",
function(){return this._repeatCount});a.prototype.__defineSetter__("repeatCount",function(a){this._repeatCount=a;this._isRunning&&(this.stop(),this.start())});a.prototype.__defineGetter__("running",function(){return this._isRunning});a.prototype.__defineGetter__("currentCount",function(){return this._count});a.prototype.start=function(){if(null===this._timer)this._timer=setInterval(this.onTick.bind(this),this._delay),this._isRunning=!0};a.prototype.reset=function(){this.stop();this._count=0};a.prototype.stop=
function(){if(null!==this._timer)clearInterval(this._timer),this._timer=null,this._isRunning=!1};a.prototype.onTick=function(){this._count+=1;0!==this._repeatCount&&this._count>this._repeatCount?(this.stop(),this.dispatchEvent(new f(f.TIMER_COMPLETE))):this.dispatchEvent(new f(f.TIMER))};return a}();JSUTILS.namespace("BREAKOUT.IOBoardEvent");
BREAKOUT.IOBoardEvent=function(){var a,f=JSUTILS.Event;a=function(a){this.name="IOBoardEvent";f.call(this,a)};a.ANALOG_DATA="analodData";a.DIGITAL_DATA="digitalData";a.FIRMWARE_VERSION="firmwareVersion";a.FIRMWARE_NAME="firmwareName";a.STRING_MESSAGE="stringMessage";a.SYSEX_MESSAGE="sysexMessage";a.CAPABILITY_RESPONSE="capabilityResponse";a.PIN_STATE_RESPONSE="pinStateResponse";a.ANALOG_MAPPING_RESPONSE="analogMappingResponse";a.READY="arduinoReady";a.CONNECTED="arduinoConnected";a.prototype=JSUTILS.inherit(f.prototype);
return a.prototype.constructor=a}();JSUTILS.namespace("BREAKOUT.WSocketEvent");BREAKOUT.WSocketEvent=function(){var a,f=JSUTILS.Event;a=function(a){this.name="WSocketEvent";f.call(this,a)};a.CONNECTED="webSocketConnected";a.MESSAGE="webSocketMessage";a.CLOSE="webSocketClosed";a.prototype=JSUTILS.inherit(f.prototype);return a.prototype.constructor=a}();JSUTILS.namespace("BREAKOUT.WSocketWrapper");
BREAKOUT.WSocketWrapper=function(){var a,f=JSUTILS.EventDispatcher,d=BREAKOUT.WSocketEvent;a=function(a,e,c,d){this.name="WSocketWrapper";f.call(this,this);this._host=a;this._port=e;this._protocol=d||"default-protocol";this._useSocketIO=c||!1;this._socket=null;this._readyState="";this.init(this)};a.prototype=JSUTILS.inherit(f.prototype);a.prototype.constructor=a;a.prototype.init=function(a){if(a._useSocketIO){a._socket=io.connect("http://"+a._host+":"+a._port);try{a._socket.on("connect",function(){a.dispatchEvent(new d(d.CONNECTED));
a._socket.on("message",function(e){a.dispatchEvent(new d(d.MESSAGE),{message:e})})})}catch(e){console.log("Error "+e)}}else try{if("MozWebSocket"in window)a._socket=new MozWebSocket("ws://"+a._host+":"+a._port,a._protocol);else if("WebSocket"in window)a._socket=new WebSocket("ws://"+a._host+":"+a._port);else throw console.log("Websockets not supported by this browser"),"Websockets not supported by this browser";console.log("Starting up...");a._socket.onopen=function(){a.dispatchEvent(new d(d.CONNECTED));
a._socket.onmessage=function(e){a.dispatchEvent(new d(d.MESSAGE),{message:e.data})};a._socket.onclose=function(){a._readyState=a._socket.readyState;a.dispatchEvent(new d(d.CLOSE))}}}catch(c){console.log("Error "+c)}};a.prototype.send=function(a){this._socket.send(a)};a.prototype.__defineGetter__("readyState",function(){return this._readyState});return a}();JSUTILS.namespace("BREAKOUT.Pin");
BREAKOUT.Pin=function(){var a,f=JSUTILS.EventDispatcher,d=JSUTILS.Event,j=BREAKOUT.generators.GeneratorEvent;a=function(a,c){this.name="Pin";this._type=c;this._number=a;this._analogNumber=void 0;this._maxPWMValue=255;this._lastValue=this._value=-1;this._average=0;this._minimum=Math.pow(2,16);this._numSamples=this._sum=this._maximum=0;this._generator=this._filters=null;this._autoSetValueCallback=this.autoSetValue.bind(this);this._evtDispatcher=new f(this)};a.prototype={setAnalogNumber:function(a){this._analogNumber=
a},get analogNumber(){return this._analogNumber},get number(){return this._number},setMaxPWMValue:function(){this._maxPWMValue=value},get maxPWMValue(){return this._maxPWMValue},get average(){return this._average},get minimum(){return this._minimum},get maximum(){return this._maximum},get value(){return this._value},set value(a){this.calculateMinMaxAndMean(a);this._lastValue=this._value;this._preFilterValue=a;this._value=this.applyFilters(a);this.detectChange(this._lastValue,this._value)},get lastValue(){return this._lastValue},
get preFilterValue(){return this._preFilterValue},get filters(){return this._filters},set filters(a){this._filters=a},get generator(){return this._generator},getType:function(){return this._type},setType:function(e){if(0<=e&&e<a.TOTAL_PIN_MODES)this._type=e},getCapabilities:function(){return this._capabilities},setCapabilities:function(a){this._capabilities=a},detectChange:function(a,c){a!==c&&this.dispatchEvent(new d(d.CHANGE))},clearWeight:function(){this._sum=this._average;this._numSamples=1},
calculateMinMaxAndMean:function(a){var c=Number.MAX_VALUE;this._minimum=Math.min(a,this._minimum);this._maximum=Math.max(a,this._maximum);this._sum+=a;this._average=this._sum/++this._numSamples;this._numSamples>=c&&this.clearWeight()},clear:function(){this._minimum=this._maximum=this._average=this._lastValue=this._preFilterValue;this.clearWeight()},addFilter:function(a){if(null!==a){if(null===this._filters)this._filters=[];this._filters.push(a)}},addGenerator:function(a){this.removeGenerator();this._generator=
a;this._generator.addEventListener(j.UPDATE,this._autoSetValueCallback)},removeGenerator:function(){null!==this._generator&&this._generator.removeEventListener(j.UPDATE,this._autoSetValueCallback);this._generator=null},setFilters:function(a){this.filters=a},removeAllFilters:function(){this._filters=null},autoSetValue:function(){this.value=this._generator.value},applyFilters:function(a){if(null===this._filters)return a;for(var c=this._filters.length,d=0;d<c;d++)a=this._filters[d].processSample(a);
return a},addEventListener:function(a,c){this._evtDispatcher.addEventListener(a,c)},removeEventListener:function(a,c){this._evtDispatcher.removeEventListener(a,c)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,c){return this._evtDispatcher.dispatchEvent(a,c)}};a.HIGH=1;a.LOW=0;a.ON=1;a.OFF=0;a.DIN=0;a.DOUT=1;a.AIN=2;a.AOUT=3;a.PWM=3;a.SERVO=4;a.SHIFT=5;a.I2C=6;a.TOTAL_PIN_MODES=7;return a}();JSUTILS.namespace("BREAKOUT.PhysicalInputBase");
BREAKOUT.PhysicalInputBase=function(){var a,f=JSUTILS.EventDispatcher;a=function(){this.name="PhysicalInputBase";this._evtDispatcher=new f(this)};a.prototype={addEventListener:function(a,f){this._evtDispatcher.addEventListener(a,f)},removeEventListener:function(a,f){this._evtDispatcher.removeEventListener(a,f)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,f){return this._evtDispatcher.dispatchEvent(a,f)}};return a}();JSUTILS.namespace("BREAKOUT.I2CBase");
BREAKOUT.I2CBase=function(){var a,f=BREAKOUT.Pin,d=JSUTILS.EventDispatcher,j=BREAKOUT.IOBoardEvent;a=function(e,c,t){if(void 0!=e){this.name="I2CDevice";this.board=e;var n=t||0,t=n&255,n=n>>8&255;this._address=c;this._evtDispatcher=new d(this);c=e.getI2cPins();2==c.length?(e.getPin(c[0]).getType()!=f.I2C&&(e.getPin(c[0]).setType(f.I2C),e.getPin(c[1]).setType(f.I2C)),e.addEventListener(j.SYSEX_MESSAGE,this.onSysExMessage.bind(this)),e.sendSysex(a.I2C_CONFIG,[t,n])):console.log("Error, this board does not support i2c")}};
a.prototype={get address(){return this._address},onSysExMessage:function(e){var e=e.message,c=this.board.getValueFromTwo7bitBytes(e[1],e[2]),d=[];if(e[0]==a.I2C_REPLY&&c==this._address){for(var c=3,f=e.length;c<f;c+=2)d.push(this.board.getValueFromTwo7bitBytes(e[c],e[c+1]));this.handleI2C(d)}},sendI2CRequest:function(e){var c=[],d=e[0];c[0]=e[1];c[1]=d<<3;for(var d=2,f=e.length;d<f;d++)c.push(e[d]&127),c.push(e[d]>>7&127);this.board.sendSysex(a.I2C_REQUEST,c)},update:function(){},handleI2C:function(){},
addEventListener:function(a,c){this._evtDispatcher.addEventListener(a,c)},removeEventListener:function(a,c){this._evtDispatcher.removeEventListener(a,c)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,c){return this._evtDispatcher.dispatchEvent(a,c)}};a.I2C_REQUEST=118;a.I2C_REPLY=119;a.I2C_CONFIG=120;a.WRITE=0;a.READ=1;a.READ_CONTINUOUS=2;a.STOP_READING=3;return a}();JSUTILS.namespace("BREAKOUT.IOBoard");
BREAKOUT.IOBoard=function(){var a=224,f=240,d=247,j=111,e=107,c=BREAKOUT.Pin,t=JSUTILS.EventDispatcher,n=JSUTILS.Event,B=BREAKOUT.WSocketEvent,O=BREAKOUT.WSocketWrapper,l=BREAKOUT.IOBoardEvent;return function(P,y,F,Q){function G(a){g.removeEventListener(l.FIRMWARE_VERSION,G);if(23<=10*a.version)g.send([f,e,d]);else throw Error("You must upload StandardFirmata version 2.3 or greater from Arduino version 1.0 or higher");}function R(){g.debug("debug: startup");g.dispatchEvent(new l(l.READY));g.enableDigitalPins()}
function H(a){a=a.substring(0,1);return a.charCodeAt(0)}function I(a){var b=a.target.getType(),d=a.target.number,a=a.target.value;switch(b){case c.DOUT:J(d,a);break;case c.AOUT:K(d,a);break;case c.SERVO:b=g.getDigitalPin(d),b.getType()==c.SERVO&&b.lastValue!=a&&K(d,a)}}function z(a){if(a.getType()==c.DOUT||a.getType()==c.AOUT||a.getType()==c.SERVO)a.hasEventListener(n.CHANGE)||a.addEventListener(n.CHANGE,I);else if(a.hasEventListener(n.CHANGE))try{a.removeEventListener(n.CHANGE,I)}catch(b){g.debug("debug: caught pin removeEventListener exception")}}
function K(i,b){var c=g.getDigitalPin(i).maxPWMValue,b=b*c,b=0>b?0:b,b=b>c?c:b;if(15<i||b>Math.pow(2,14)){var c=b,h=[];if(c>Math.pow(2,16))throw console.log("Extended Analog values > 16 bits are not currently supported by StandardFirmata"),"Extended Analog values > 16 bits are not currently supported by StandardFirmata";h[0]=f;h[1]=j;h[2]=i;h[3]=c&127;h[4]=c>>7&127;c>=Math.pow(2,14)&&(h[5]=c>>14&127);h.push(d);g.send(h)}else g.send([a|i&15,b&127,b>>7&127])}function J(a,b){var d=Math.floor(a/8);if(b==
c.HIGH)u[d]|=b<<a%8;else if(b==c.LOW)u[d]&=~(1<<a%8);else{console.log("Warning: Invalid value passed to sendDigital, value must be 0 or 1.");return}g.sendDigitalPort(d,u[d])}this.name="IOBoard";var g=this,o,C=0,D=0,s=[],p=[],q=0,u=[],v,E=[],L=[],M=[],r=[],w=0,N=19,x=0,A=new t(this);!F&&"number"===typeof y&&(y+="/websocket");o=new O(P,y,F,Q);o.addEventListener(B.CONNECTED,function(){console.log("Socket Status: (open)");g.dispatchEvent(new l(l.CONNECTED));g.addEventListener(l.FIRMWARE_VERSION,G);g.reportVersion()});
o.addEventListener(B.MESSAGE,function(i){var i=i.message,i=1*i,b;if(0<q&&128>i){if(q--,s[q]=i,0==q)switch(C){case 144:var e=8*D;b=e+8;var i=s[1]|s[0]<<7,h={};b>=w&&(b=w);for(var k=0,j=e;j<b;j++){h=g.getDigitalPin(j);if(void 0==h)break;if(h.getType()==c.DIN&&(e=i>>k&1,e!=h.value))h.value=e,g.dispatchEvent(new l(l.DIGITAL_DATA),{pin:h});k++}break;case 249:x=s[1]+s[0]/10;g.dispatchEvent(new l(l.FIRMWARE_VERSION),{version:x});break;case a:b=g.getAnalogPin(D);if(void 0==b)break;b.value=g.getValueFromTwo7bitBytes(s[1],
s[0])/1023;b.value!=b.lastValue&&g.dispatchEvent(new l(l.ANALOG_DATA),{pin:b})}}else if(0>q)if(i==d){q=0;switch(p[0]){case 121:b=p;i="";for(k=3;k<b.length;k+=2)h=String.fromCharCode(b[k]),h+=String.fromCharCode(b[k+1]),i+=h;x=b[1]+b[2]/10;g.dispatchEvent(new l(l.FIRMWARE_NAME),{name:i,version:x});break;case 113:b=p;i="";for(k=1;k<b.length;k+=2)h=String.fromCharCode(b[k]),h+=String.fromCharCode(b[k+1]),i+=h.charAt(0);g.dispatchEvent(new l(l.STRING_MESSAGE),{message:i});break;case 108:for(var i=p,h=
{},k=1,e=b=0,j=i.length,m;k<=j;)if(127==i[k]){L[b]=b;m=void 0;if(h[c.DOUT])m=c.DOUT;if(h[c.AIN])m=c.AIN,E[e++]=b;m=new c(b,m);m.setCapabilities(h);z(m);r[b]=m;m.getCapabilities()[c.I2C]&&M.push(m.number);h={};b++;k++}else h[i[k]]=i[k+1],k+=2;v=Math.ceil(b/8);g.debug("debug: num ports = "+v);for(i=0;i<v;i++)u[i]=0;w=b;g.debug("debug: num pins = "+w);g.send([f,105,d]);break;case 110:i=p;h=i.length;k=i[1];e=i[2];j=r[k];4<h?b=g.getValueFromTwo7bitBytes(i[3],i[4]):3<h&&(b=i[3]);j.getType()!=e&&(j.setType(e),
z(j));if(j.value!=b)j.value=b;g.dispatchEvent(new l(l.PIN_STATE_RESPONSE),{pin:k,type:e,value:b});break;case 106:b=p;i=b.length;for(h=1;h<i;h++)127!=b[h]&&(E[b[h]]=h-1,g.getPin(h-1).setAnalogNumber(b[h]));g.debug("debug: system reset");g.send(255);setTimeout(R,500);g.debug("debug: configured");break;default:g.dispatchEvent(new l(l.SYSEX_MESSAGE),{message:p})}p=[]}else p.push(i);else switch(240>i?(b=i&240,D=i&15):b=i,b){case 249:case 144:case a:q=2;C=b;break;case f:q=-1,C=b}});o.addEventListener(B.CLOSE,
function(){console.log("Socket Status: "+o.readyState+" (Closed)")});this.__defineGetter__("samplingInterval",function(){return N});this.__defineSetter__("samplingInterval",function(a){10<=a&&100>=a?(N=a,g.send([f,122,a&127,a>>7&127,d])):console.log("Warning: Sampling interval must be between 10 and 100")});this.getValueFromTwo7bitBytes=function(a,b){return b<<7|a};this.getSocket=function(){return o};this.reportVersion=function(){g.send(249)};this.reportFirmware=function(){g.send([f,121,d])};this.disableDigitalPins=
function(){for(var a=0;a<v;a++)g.sendDigitalPortReporting(a,c.OFF)};this.enableDigitalPins=function(){for(var a=0;a<v;a++)g.sendDigitalPortReporting(a,c.ON)};this.sendDigitalPortReporting=function(a,b){g.send([208|a,b])};this.enableAnalogPin=function(a){g.send([192|a,c.ON]);g.getAnalogPin(a).setType(c.AIN)};this.disableAnalogPin=function(a){g.send([192|a,c.OFF]);g.getAnalogPin(a).setType(c.AIN)};this.setDigitalPinMode=function(a,b){g.getDigitalPin(a).setType(b);z(g.getDigitalPin(a));g.send([244,a,
b])};this.enablePullUp=function(a){J(a,c.HIGH)};this.getFirmwareVersion=function(){return x};this.sendDigitalPort=function(a,b){g.send([144|a&15,b&127,b>>7])};this.sendString=function(a){for(var b=[],c=0,d=a.length;c<d;c++)b.push(H(a[c])&127),b.push(H(a[c])>>7&127);this.sendSysex(113,b)};this.sendSysex=function(a,b){var c=[];c[0]=f;c[1]=a;for(var e=0,j=b.length;e<j;e++)c.push(b[e]);c.push(d);g.send(c)};this.sendServoAttach=function(a,b,e){var b=b||544,e=e||2400,h=[];h[0]=f;h[1]=112;h[2]=a;h[3]=b%
128;h[4]=b>>7;h[5]=e%128;h[6]=e>>7;h[7]=d;g.send(h);a=g.getDigitalPin(a);a.setType(c.SERVO);z(a)};this.queryPinState=function(a){g.send([f,109,a.number,d])};this.getPin=function(a){return r[a]};this.getAnalogPin=function(a){return r[E[a]]};this.getDigitalPin=function(a){return r[L[a]]};this.analogToDigital=function(a){return g.getAnalogPin(a).number};this.getPinCount=function(){return w};this.getI2cPins=function(){return M};this.reportCapabilities=function(){for(var a={"0":"input",1:"output",2:"analog",
3:"pwm",4:"servo",5:"shift",6:"i2c"},b=0,c=r.length;b<c;b++)for(var d in r[b].getCapabilities())console.log("pin "+b+"\tmode: "+a[d]+"\tresolution (# of bits): "+r[b].getCapabilities()[d])};this.send=function(a){o.send(a)};this.close=function(){console.log("socket = "+o);o.close()};this.debug=function(a){console.log(a)};this.addEventListener=function(a,b){A.addEventListener(a,b)};this.removeEventListener=function(a,b){A.removeEventListener(a,b)};this.hasEventListener=function(a){return A.hasEventListener(a)};
this.dispatchEvent=function(a,b){return A.dispatchEvent(a,b)}}}();
